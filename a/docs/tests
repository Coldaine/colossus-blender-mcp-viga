"""
Quick test script to verify Blender MCP connection
Run this to ensure everything is working before running full examples
"""

import asyncio
import sys
sys.path.append("src")

from colossus_blender import create_blender_client


async def test_blender_connection():
    """Test connection to Blender MCP server"""

    print("\n" + "=" * 60)
    print("BLENDER MCP CONNECTION TEST")
    print("=" * 60 + "\n")

    print("[1/5] Attempting to connect to Blender...")
    try:
        client = await create_blender_client(
            mode="socket",
            host="localhost",
            port=9876
        )

        if client._connected:
            print("âœ“ Successfully connected to Blender on localhost:9876\n")
        else:
            print("âœ— Failed to connect to Blender")
            print("\nTroubleshooting:")
            print("  1. Make sure Blender is running")
            print("  2. Enable the MCP addon in Blender Preferences")
            print("  3. Check that server started on port 9876")
            print("  4. Look for 'MCP Server Started' in Blender console")
            return False

    except Exception as e:
        print(f"âœ— Connection error: {e}\n")
        return False

    # Test scene info retrieval
    print("[2/5] Testing scene info retrieval...")
    try:
        info = await client.get_scene_info()
        if info.get("status") == "success":
            scene_info = info.get("scene_info", {})
            print(f"âœ“ Scene info retrieved successfully")
            print(f"  - Objects: {len(scene_info.get('objects', []))}")
            print(f"  - Lights: {len(scene_info.get('lights', []))}")
            print(f"  - Cameras: {len(scene_info.get('cameras', []))}")
            print(f"  - Materials: {len(scene_info.get('materials', []))}\n")
        else:
            print(f"âœ— Failed to get scene info: {info.get('message')}\n")
    except Exception as e:
        print(f"âœ— Error getting scene info: {e}\n")

    # Test code execution
    print("[3/5] Testing code execution...")
    test_code = """
import bpy
import json

def test_execution():
    try:
        # Simple test: get Blender version
        version = ".".join(map(str, bpy.app.version))
        return {
            "status": "success",
            "blender_version": version,
            "message": "Code execution successful"
        }
    except Exception as e:
        return {"status": "error", "message": str(e)}

result = test_execution()
print(json.dumps(result))
"""

    try:
        result = await client.execute_code(test_code)
        if result.get("status") == "success":
            print(f"âœ“ Code execution successful")
            print(f"  - Blender version: {result.get('blender_version', 'Unknown')}\n")
        else:
            print(f"âœ— Code execution failed: {result.get('errors')}\n")
    except Exception as e:
        print(f"âœ— Execution error: {e}\n")

    # Test screenshot capability
    print("[4/5] Testing screenshot capture...")
    try:
        screenshot = await client.get_viewport_screenshot(max_size=512)
        if screenshot.get("status") == "success":
            img_data = screenshot.get("image_data", "")
            print(f"âœ“ Screenshot captured successfully")
            print(f"  - Format: {screenshot.get('format', 'unknown')}")
            print(f"  - Size: {screenshot.get('width')}x{screenshot.get('height')}")
            print(f"  - Data length: {len(img_data)} chars (base64)\n")
        else:
            print(f"âœ— Screenshot capture failed: {screenshot.get('message')}\n")
    except Exception as e:
        print(f"âœ— Screenshot error: {e}\n")

    # Test GPU configuration
    print("[5/5] Testing GPU configuration...")
    from colossus_blender.gpu_config import get_gpu_config

    try:
        gpu_config = get_gpu_config("3090")
        config_code = gpu_config.generate_blender_code("preview")

        result = await client.execute_code(config_code)
        if result and "success" in str(result).lower():
            print(f"âœ“ GPU configuration successful")
            print(f"  - GPU Model: RTX 3090")
            print(f"  - Quality: Preview")
            print(f"  - Samples: 64\n")
        else:
            print(f"âš  GPU configuration executed but check Blender console for details\n")
    except Exception as e:
        print(f"âœ— GPU config error: {e}\n")

    # Disconnect
    await client.disconnect()

    print("=" * 60)
    print("CONNECTION TEST COMPLETE")
    print("=" * 60)
    print("\nâœ“ All tests passed! You're ready to run the examples.")
    print("\nNext steps:")
    print("  1. Run basic example: cd examples && python basic_usage.py")
    print("  2. Try advanced workflows: python advanced_workflow.py multi")
    print("  3. Read SETUP_GUIDE.md for more details\n")

    return True


async def test_api_keys():
    """Test that API keys are configured"""

    print("\n" + "=" * 60)
    print("API KEYS TEST")
    print("=" * 60 + "\n")

    import os

    anthropic_key = os.getenv("ANTHROPIC_API_KEY")
    google_key = os.getenv("GOOGLE_API_KEY")

    if anthropic_key:
        print(f"âœ“ ANTHROPIC_API_KEY is set (length: {len(anthropic_key)})")
    else:
        print("âœ— ANTHROPIC_API_KEY is not set")
        print("  Set it with: setx ANTHROPIC_API_KEY \"your-key\"")

    if google_key:
        print(f"âœ“ GOOGLE_API_KEY is set (length: {len(google_key)})")
    else:
        print("âœ— GOOGLE_API_KEY is not set")
        print("  Set it with: setx GOOGLE_API_KEY \"your-key\"")

    print()

    if anthropic_key and google_key:
        return True
    else:
        print("âš  API keys not configured. Set them before running examples.\n")
        return False


if __name__ == "__main__":
    print("\nðŸš€ Starting Colossus Blender MCP Tests...\n")

    # Test API keys first
    asyncio.run(test_api_keys())

    # Test Blender connection
    asyncio.run(test_blender_connection())
